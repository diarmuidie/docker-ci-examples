machine:
  services:
    - docker
  environment:
    DOCKER_ENGINE_VERSION: 1.10.0
    DOCKER_COMPOSE_VERSION: 1.7.1
    DOCKER_IMAGE: diarmuidie/circleci-docker-ci-example

dependencies:
  override:
    - docker --version
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- ${DOCKER_ENGINE_VERSION}
    - docker version
    - pip install -I docker-compose==${DOCKER_COMPOSE_VERSION}
    - docker-compose --version
    - docker-compose run composer install --no-interaction --no-scripts

test:
  override:
    - docker-compose run php vendor/bin/phpunit

deployment:
  hub:
    branch: /.*/
    commands:
      # Remove dev dependencies
      - docker-compose run composer install --no-dev --no-interaction --no-scripts --optimize-autoloader

      # Tag the docker images using the commit hash
      - docker build --tag ${DOCKER_IMAGE}:${CIRCLE_SHA1} ./;

      # Tag docker image as 'latest' if it is the master branch
      - if [ "$CIRCLE_BRANCH" == "master" ]; then
            docker tag ${DOCKER_IMAGE}:${CIRCLE_SHA1} ${DOCKER_IMAGE}:latest;
        fi;

      # Tag docker image with the git tag
      - if [ ! -z  "$CIRCLE_TAG" ]; then
            docker tag ${DOCKER_IMAGE}:${CIRCLE_SHA1} ${DOCKER_IMAGE}:${CIRCLE_TAG};
        fi;

      # Push the images to Docker Hub
      - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD";
        docker push ${DOCKER_IMAGE};
